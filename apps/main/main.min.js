var STOR=require("Storage");var wOSI2C=new I2C;wOSI2C.setup({scl:D14,sda:D15,bitrate:2E5});
global.wOS={ON_TIME:10,BRIGHT:.5,FACEUP:true,VIBRATE:true,awake:true,time_left:10,ticker:undefined,settings:undefined,buzz:function(v){if(!wOS.VIBRATE)return;v=v?v:100;if(v<=50)digitalPulse(D6,false,v);else{D6.reset();setTimeout(function(){D6.set()},v)}},batV:function(){return 7*analogRead(D30)},isCharging:function(){return!D8.read()},setLCDTimeout:function(v){wOS.ON_TIME=v<5?5:v},brightness:function(v){v=v>1?1:v<0?0:v;if(v==0||v==1)digitalWrite(D12,v);else analogWrite(D12,v,{freq:60})},setLCDBrightness:function(v){wOS.BRIGHT=
v;wOS.brightness(v)},init:function(){var s=STOR.readJSON("settings.json",1)||{ontime:10,bright:.5,timezone:1,faceup:true,vibrate:true};wOS.ON_TIME=s.ontime;wOS.time_left=s.ontime;wOS.BRIGHT=s.bright;wOS.FACEUP=s.faceup;wOS.VIBRATE=typeof s.vibrate!="undefined"?s.vibrate:true;wOS.settings=s;E.setTimeZone(s.timezone)},sleep:function(){wOS.awake=false;wOS.brightness(0);TC.stop();wOS.emit("lcdPower",false);g.flip();g.lcd_sleep()},wake:function(){wOS.awake=true;wOS.time_left=wOS.ON_TIME;TC.start();g.lcd_wake();
wOS.emit("lcdPower",true);wOS.brightness(wOS.BRIGHT);wOS.ticker=setInterval(wOS.tick,1E3)},setLCDPower:function(b){if(b)if(wOS.awake)wOS.time_left=wOS.ON_TIME;else wOS.wake();else wOS.sleep()},isLCDOn:function(){return wOS.awake},tick:function(){wOS.time_left--;if(wOS.time_left<=0){if(wOS.ticker)wOS.ticker=clearInterval(wOS.ticker);wOS.emit("sleep",true);wOS.sleep()}}};
function watchBat(){setWatch(function(){if(!wOS.awake)wOS.wake();wOS.emit("charging",wOS.isCharging())},D8,{edge:"both",repeat:true,debounce:500})}wOS.init();eval(STOR.read("lcd.js"));var g=ST7789();g.theme={fg:65535,bg:0,fg2:2047,bg2:0,fgH:65535,bgH:31,dark:true};wOS.brightness(wOS.BRIGHT);eval(STOR.read("touch.js"));TC.start();if(wOS.FACEUP&&STOR.read("accel.js")){eval(STOR.read("accel.js"));ACCEL.init();ACCEL.on("faceup",function(){if(!wOS.awake)wOS.wake()})}wOS.ticker=setInterval(wOS.tick,1E3);
wOS.POWER=wOS.isCharging();watchBat();if(STOR.read("alarm.boot.js"))eval(STOR.read("alarm.boot.js"));wOS.btnWatches=[setWatch(function(){if(wOS.awake)load(wOS.settings.clock)},BTN1,{repeat:1})];setWatch(function(){if(wOS.awake)wOS.time_left=wOS.ON_TIME;else wOS.wake()},BTN1,{repeat:true,edge:"falling"});setWatch(function(){if(wOS.awake){wOS.time_left=wOS.ON_TIME;if(!wOS.btnWatches)setTimeout(reset,500)}else wOS.wake()},BTN2,{repeat:true,edge:"falling"});global.Bangle=wOS;
E.getBattery=function(){var v=wOS.batV();v=v<3.7?3.7:v;return Math.floor((v-3.7)*200)};wOS.showLauncher=function(){load("launch.js")};eval(STOR.read("menu.js"));eval(STOR.read("prompt.js"));eval(STOR.read("widgets.js"));